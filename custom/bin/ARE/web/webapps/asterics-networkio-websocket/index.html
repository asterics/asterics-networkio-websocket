<!-- this is an example for an AsTeRICS demo solution startpage. Please edit it for your needs. -->

<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" type="text/css" href="../startpage/styles/main.css">

	<!-- provided from AsTeRICS 3.0 -->
	<script type="text/javascript" src="../startpage/lib/jquery-3.2.1.min.js"></script>
	<script src="../startpage/lib/smoothie.js"></script>
	
    <script src="../startpage/clientExample/javascript/JSmap.js"></script>
    <script src="../startpage/clientExample/javascript/areCommunicator.js"></script>
	<!-- provided by this repository, should be part of the framework later -->
	<script src="../startpage/lib/demoLib.js"></script>

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

	<script type="text/javascript">
		/*
		Deploy model file which is hosted on a webserver, apply settings (camera device, speed) and start the model.
		*/		
		function applyAndStart() {
			/*
			var cameraSource = document.getElementById("cameraSource");
			var cameraSourceIdx = cameraSource.options[cameraSource.selectedIndex].value;
			var speed = document.getElementById("speed").value;
			*/
			//The JSON object must be sent as JSON string, the keys and values must be Strings as well.
			var propertyMap=JSON.stringify(
			{
				/*
				"XFacetrackerLK.1":{
					"cameraSelection":String(cameraSourceIdx)
				},
				"Slider.1":{
				  "default":String(speed)
				}
				*/
			});
			console.log("Setting model properties:"+propertyMap);
			
			//Here is an example of how you could store a file from the webserver to the ARE/data folder.
			/*
			storeFileFromWebserverOnARE('webapps/asterics-camerainput-cameramouse/models/XFaceTrackerMouse(WLM).acs', 'testModel/testModel.acs', Empty_successCallback);
			*/

			//Now let's deploy the model file, apply all settings the user selected and start the model.
			deployModelFromWebserverApplySettingsAndStartModel('webapps/asterics-networkio-websocket/models/WebSocket-SignalGeneratorDemo(WLM).acs',propertyMap);
			
			initSocket();
		}
		
		
		/* ------------------ Websocket initialization and callback handler ---------------------- */
		var wsUri = "ws://localhost:8082/ws/astericsData";
		
		function initSocket() {
			websocket = new WebSocket(wsUri);
			websocket.onopen = function(evt) {
				onOpen(evt)
			};
			websocket.onclose = function(evt) {
				onClose(evt)
			};
			websocket.onmessage = function(evt) {
				onMessage(evt)
			};
			websocket.onerror = function(evt) {
				onError(evt)
			};
		}
		function onOpen(evt) {
			writeToScreen("CONNECTED");
			doSend("WebSocket rocks");
		}
		function onClose(evt) {
			writeToScreen("DISCONNECTED");
		}
		function onMessage(evt) {
			//update value field
			var receivedValueElem = document.getElementById("received-value");
			receivedValueElem.value = evt.data;

			//update graph with new value
			graph1.data = Number(evt.data);
		}
		function onError(evt) {
			writeToScreen('ERROR:' + evt.data);
		}
		
		function doSend(message) {
			writeToScreen("SENT: " + message);
			websocket.send(message);
		}
		function writeToScreen(message) {
			var output = document.getElementById("websocket-status");
			var linebreak = '\n';
			if(output.value) {
				output.value += linebreak + message;
			} else {
				output.value = message;
			}
		}
		
		/* -------------- Smoothie live chart ---------------------- */
		var graph1 = {
			smoothie:new SmoothieChart(),
			plot:new TimeSeries(),
			data:0
		};
		
		function initGraph1() //Initialize Graph 1
		{
			graph1.smoothie.streamTo(document.getElementById("myGraph1"));
			graph1.smoothie.addTimeSeries(graph1.plot, {
				strokeStyle : 'rgb(0, 255, 0)',
				lineWidth : 2
			});

			setInterval(function() {
				graph1.plot.append(new Date().getTime(), graph1.data);
			}, 10);
		}

		window.onload = function() {
			initSocket();
			initGraph1();
		};
	</script>
	
    <title>Asterics Websocket Demo</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>Asterics Websocket Demo</h1>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
			<h4>Objective</h4>Visualization of signal data in a web live chart using Javascript.
			<h4>Description</h4>The demo generates a sine signal and broadcasts the signal data through a websocket <strong>(ws://localhost:8082/ws/astericsData)</strong>. The data is visualized in a Javascript live chart. You can also send data to the model by pressing the "Send test message" button.
			<p>

			<div>
			<img src="img/Websockets-main.PNG" alt="Visualization of sine signal"/>
			</div>
			<p>
			<!--
					<label for="cameraSource">Choose Camera: </label>
					<select id="cameraSource">
					  <option value="0">First camera</option>
					  <option value="1">Second camera</option>
					  <option value="2">Third camera</option>
					  <option value="3">Fourth camera</option>
					</select>			
					<label for="speed">Mouse Speed: </label>
					<input title="Mouse speed" type="range" id="speed" value="50">
			<br>
			-->
			<button onclick="applyAndStart()" title="Description: Applies all settings and starts the model" class="button"> Apply and Start Model </button>
			<p>
			<div id="gPanel" align="vertical">
				<h5>Visualization of Signal</h5>				
				<div align="vertical">
					<canvas id="myGraph1" width="400" height="100"></canvas>
					<div align="horizontal">
						<label for="received-value">Received value: </label>
						<input id="received-value" type="text" readOnly="true">
					</div>
				</div>
				<p>
				<div align="horizontal">
					<label for="websocket-status">Websocket status: </label>
					<textarea id="websocket-status" readOnly="true"></textarea>
				</div>				
			</div>
			<h4>Requirements</h4>
			<ul>
				<li><a href="https://github.com/asterics/AsTeRICS/releases/tag/v3.0" target="_blank">AsTeRICS 3.0</a> installed and ARE running</li>
				<li>OS: Windows, Linux (incl. RPi), Mac OSX</li>
			</ul>
			<h4>Major Plugins</h4>
			<ul>
				<li><a target="_blank" href="http://asterics.github.io/AsTeRICS/webapps/WebACS/help/index.html?plugins&processors/WebSocket.htm">WebSocket</a></li>
				<li><a target="_blank" href="http://asterics.github.io/AsTeRICS/webapps/WebACS/help/index.html?plugins&sensors/SignalGenerator.htm">SignalGenerator</a></li>
			</ul>
			<h4>Edit Model</h4>
			<a target="_blank" href="http://asterics.github.io/AsTeRICS/webapps/WebACS/?areBaseURI=http://localhost:8081&openFile=http://asterics.github.io/AsTeRICS/webapps/asterics-networkio-websocket/models/WebSocket-SignalGeneratorDemo(WLM).acs">Open in WebACS</a>
			<h4>Source Repository</h4>
				You can fork and modify this <a target="_blank" href="https://github.com/asterics/asterics-networkio-websocket">repository</a>.
			<!--
			<h4>Related Videos</h4>
			<a target="_blank" href="https://youtu.be/P9qJAWegkFM?t=1955">Camera Mouse Demo Screencast</a>
			<p>
			<a target="_blank" href="https://youtu.be/P9qJAWegkFM?t=2228">Camera Mouse Model Creation Screencast</a>
			-->
			<h4>Related Tutorials</h4>
			<!--
			<a target="_blank" href="https://github.com/asterics/AsTeRICS/blob/master/Documentation/AsTeRICS_CameraMouseCreation_StepbyStep_Tutorial.pdf">Camera Mouse Creation StepbyStep Tutorial</a>
			-->
			</section>
      </div>
    </div>
  </body>
</html>
